# Module overviews

**List of Modules:**

* [UCSC Trackhub generation](#ucsc-trackhub-generation)

---

## UCSC Trackhub generation ##

Trackhub generation for a project's bigwig and/or peak files is split into two tasks: configuration file generation and trackhub generation from an existing configuration file.

This module is currently implemented for the `RNAseq`, `ChIPseq` and `ChIPseq_pe` pipelines. However they are still disabled (commented out) by default.

### Configuration file generation ###

*Script: tools/trackhub/Configure_Trackhub.R*

The trackhub configuration file is generated from the `targets.txt` file. It is in [YAML format](https://en.wikipedia.org/wiki/YAML) and consists of two sections:

* A `Global` section that contains general variables, like genome assembly, file system location to copy the tracks to, and base URL for external access.

* A `Tracks` section with per-track configuration data. This is used to generate the `tracksDb.txt` file for the UCSC trackhub.


If the `targets.txt` file contains the `IP`, `IPname`, `INPUT` or `INPUTname` fields it it treated as a **ChIP-seq** sample. The `IP` tracks are colored blue by default and the `INPUT` tracks grey. The IP tracks are not paired with the input tracks into multiwig containers because it is possible for one input track to be used for several IP tracks, and trackhub tracks cannot be duplicated. Bigwig track file names are explicitly specified in the targets file (`IP` & `INPUT` fields), but the peak file names are constructed from the corresponding `IPname` & `INPUTname` fields in the same way that the `macs2` module does it.

For **RNA-seq**, the bigwig track file names are obtained from the `.readcounts.tsv` file names in the targets file. They are colored blue if unstranded, and green (forward) or red (reverse) if stranded. For stranded tracks the two strand-specific bigwigs are combined into multiwig containers. Strandedness is taken from the `ESSENTIAL_STRANDED` variable. The stranded bigwigs need to have the `.fwd.bw` and `.rev.bw` extensions, as generated by the `strandSpecificBW` module. This is because the bigwig file names are automatically derived from the *".readcounts.tsv"* file name as described above.

For experiments that are **neither ChIP-seq nor RNA-seq**, a `targets.txt` file needs to be created to identify the tracks. It should contain at least two columns, named `sample` and `file`, that contain the sample name and base file name (*without extension*) respectively. This can be used for instance for DNA-seq experiments like the various break site identification techniques, and perhaps for ATAC-seq samples.

Any **tracks present in the tracks folder but not listed in the targets file** are generated as standalone grey tracks. The track names are derived from the file names. Whether this is desirable default behavior is open for discussion, but it is useful for instance when not all tracks are used in the peak calling or DE analysis (and some are thus absent from the targets file), but they still all need to be viewable in the browser.

### Track hub generation ###

*Script: tools/trackhub/Make_Trackhub.R*

This module copies the tracks to the public FTP location and creates the trackhub files for the UCSC Genome Browser. It reads the `trackhub.yaml` YAML configuration file generated by the trackhub configuration module. When complete, it generates a corresponding `trackhub.done` file in the main project directory with the trackhub URL for the UCSC Genome Browser.

The reporting modules for the RNA-seq & ChIP-seq pipelines have been modified to read the trackhub URL from this file and include it into the reports.

Bigwig tracks are simply copied to the FTP location. ChIP-seq peak files in `.narrowPeak` or `.broadPeak` format are first converted into bigBed files, which are required to display BED-type tracks in trackhubs. This conversion step makes use ot the UCSC bedToBigBed tool and requires the appropriate format specification files for the narrowPeak/broadPeak files. Their location is given in the `TRACKHUB_UCSCCFG` variable. It also requires a chromosome sizes file, which is specified in the `ESSENTIAL_CHROMSIZES` variable. The genome `.fa.fai` fasta index file generated by samtools is suitable for this purpose, and can be used as is, without modification. (Example file: *"/fsimb/common/genomes/mus_musculus/ucsc/mm10/full/genome/mm10.sorted.fa.fai"*)

Trackhub configuration YAML files can be created manually, but they need to contain all the relevant global fields as well as the track-specific data. It may be easier to modify a file generated by the trackhub configuration module. Small tweaks like modifying track colors can also be made directly to the generated `trackDb.txt` file, but they will be overwritten if the trackhub is regenerated.

***Note:** Existing bigwig/bigbed track files at the trackhub FTP location are not overwritten when the trackhub module is re-run. This is to prevent excessive copying when tweaking and regenerating trackhubs to customize them. If the bigwig/bigbed files need to be updated then the previous ones should be deleted first.*

### Current limitations ###

* Can only generate tracks for one genome assembly. However since NGSpipe2go projects can generally only work with one genome assembly at a time, this should probably not be a limitation in practice.

* Currently always requires the `ESSENTIAL_CHROMSIZES` variable to be specified, which points to the chromosome sizes file for the relevant genome assembly (can be `.fa.fai` genome fasta index file). However this is only needed to process ChIP-seq peak files, so this requirement should be removed for other experiment types.

### Wishlist ###

* Merge pre-existing configuration file with automatically generated one, so that manual tweaks are maintained when the configuration file is regenerated.

* Shiny app for trackhub configuration.


### Examples ###

Example trackhub configuration YAML file:

```yaml
#####################################################################
## TrackHub configuration file (YAML format)
## YAML: https://en.wikipedia.org/wiki/YAML
## YAML basics:
##     http://cheat.readthedocs.io/en/latest/yaml.html
##     https://lzone.de/cheat-sheet/YAML
##
## Beware: In YAML indentation is significant!
##         Indentation level indicates nesting of sections.
##
## Note: Quote strings that begin with numbers (e.g. color field)
##       otherwise they will not be parsed correctly.
##       Other strings do not need to be quoted.
##       This is part of the YAML specification, not a bug.
## -----------------------------------------------------------------
## Note: This is just an example file to illustrate the fields.
##       These YAML files would normally be generated by the
##       trackhub configuration module.
#####################################################################


# Global variables

Global:
  TRACKHUB_FTPURLBASE: http://imbc1.imb.uni-mainz.de/public
  TRACKHUB_FTPBASE: /fsimb/services/ftp/public/
  TRACKHUB_UCSCCFG: /fsimb/common/tools/ucsc/config/
  TRACKHUB_ASSEMBLY: mm10
  TRACKHUB_CHROMSIZES: /fsimb/common/genomes/mus_musculus/ucsc/mm10/full/genome/mm10.sorted.fa.fai
  TRACKHUB_TARGETS: /path/to/projectdir/targets.txt
  TRACKHUB_TRACKSDIR: /path/to/projectdir/tracks            # location of track bigwigs/bigbeds
  TRACKHUB_PEAKSDIR: /path/to/projectdir/results/macs2      # location of peak files (narrowPeak/broadPeak)


# Individual track configuration
# Order of tracks below is maintained in 'trackDb.txt' file

Tracks:

  # ChIP-seq tracks

  Control_Signal:
    type: bigWig
    file: chipseq_control.bw
    shortLabel: Control
    longLabel: Control sample BigWig
    color: '128,128,128'                # quote to prevent interpretation as number

  Sample1_Signal:
    type: bigWig
    file: chipseq_sample1.bw
    shortLabel: Sample1
    longLabel: Chip sample 1 BigWig
    color: '255,128,128'
  Sample1_Peaks:
    type: bigBed
    file: chipseq_sample1.bb
    shortLabel: Sample1
    longLabel: Chip sample 1 peaks
    color: '255,128,128'

  Sample2_Signal:
    type: bigWig
    file: chipseq_sample2.bw
    shortLabel: Sample2
    longLabel: Chip sample 2 BigWig
    color: '128,255,128'
  Sample2_Peaks:
    type: bigBed
    file: chipseq_sample2.bb
    shortLabel: Sample2
    longLabel: Chip sample 2 peaks
    color: '128,255,128'


  # RNA-seq tracks (stranded; strands grouped in multiWig containers)

  # MultiWig containers -- define container before contained wiggle tracks

  Sample1_RNAseq:
    container: multiWig
    shortLabel: Sample1
    longLabel: Stranded RNAseq Sample 1 BigWigs
  Sample2_RNAseq:
    container: multiWig
    shortLabel: Sample2
    longLabel: Stranded RNAseq Sample 2 BigWigs


  # RNA-seq forward & reverse strand wiggle tracks

  Sample1_forward:
    type: bigWig
    file: rnaseq_sample1.fwd.bw
    parent: Sample1_RNAseq
    shortLabel: Sample1.fwd
    longLabel: Sample 1 forward strand
    color: '255,128,128'
  Sample1_reverse:
    type: bigWig
    file: rnaseq_sample1.rev.bw
    parent: Sample1_RNAseq
    shortLabel: Sample1.rev
    longLabel: Sample 1 reverse strand
    color: '128,128,255'

  Sample2_forward:
    type: bigWig
    file: rnaseq_sample2.fwd.bw
    parent: Sample2_RNAseq
    shortLabel: Sample2.fwd
    longLabel: Sample 2 forward strand
    color: '255,128,128'
  Sample2_reverse:
    type: bigWig
    file: rnaseq_sample2.rev.bw
    parent: Sample2_RNAseq
    shortLabel: Sample2.rev
    longLabel: Sample 2 reverse strand
    color: '128,128,255'


  # RNA-seq unstranded wiggle track

  Sample3_unstranded:
    type: bigWig
    file: rnaseq_sample3.bw
    shortLabel: Sample3
    longLabel: Sample 3 unstranded RNA-seq
    color: '128,255,128'
```

------
